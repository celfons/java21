global
    daemon
    stats socket /var/run/haproxy.sock mode 660 level admin
    maxconn 4096

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog
    option dontlognull
    option redispatch
    retries 3
    balance roundrobin

# Frontend for the main application
frontend rinha_frontend
    bind *:8080
    default_backend rinha_backend

# Backend for application instances
backend rinha_backend
    option httpchk GET /actuator/health
    http-check expect status 200
    server rinha-app-1 rinha-app-1:8080 check inter 10s fall 3 rise 2
    server rinha-app-2 rinha-app-2:8080 check inter 10s fall 3 rise 2

# Frontend for mock default processor
frontend default_processor_frontend
    bind *:8081
    default_backend default_processor_backend

# Backend for default processor
backend default_processor_backend
    server mock-default mock-processor-default:80 check

# Frontend for mock fallback processor
frontend fallback_processor_frontend
    bind *:8082
    default_backend fallback_processor_backend

# Backend for fallback processor
backend fallback_processor_backend
    server mock-fallback mock-processor-fallback:80 check

# HAProxy stats page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node