name: Native Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-jvm:
    name: Test on JVM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Run tests
        run: mvn clean test
        
      - name: Build JAR
        run: mvn clean package -DskipTests
        
      - name: Test JAR execution
        run: |
          java -jar target/crud-app-*.jar &
          APP_PID=$!
          sleep 10
          curl -f http://localhost:8080/api/users/health || exit 1
          kill $APP_PID

  native-build:
    name: Native Build with GraalVM
    runs-on: ubuntu-latest
    needs: test-jvm
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: 'true'
          
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Build native image
        run: mvn -Pnative native:compile
        env:
          MAVEN_OPTS: "-Xmx4g"
          
      - name: Test native executable
        run: |
          ./target/crud-app &
          APP_PID=$!
          sleep 5
          curl -f http://localhost:8080/api/users/health || exit 1
          kill $APP_PID
          
      - name: Upload native executable
        uses: actions/upload-artifact@v3
        with:
          name: crud-app-native
          path: target/crud-app
          
  performance-test:
    name: Performance Comparison
    runs-on: ubuntu-latest
    needs: [test-jvm, native-build]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: Build both versions
        run: |
          mvn clean package -DskipTests
          mvn -Pnative native:compile
          
      - name: Test JVM startup time
        run: |
          echo "Testing JVM startup time..."
          for i in {1..3}; do
            start_time=$(date +%s%N)
            java -jar target/crud-app-*.jar &
            APP_PID=$!
            
            # Wait for app to be ready
            timeout 30 bash -c 'until curl -f http://localhost:8080/api/users/health 2>/dev/null; do sleep 0.1; done'
            end_time=$(date +%s%N)
            startup_time=$(( (end_time - start_time) / 1000000 ))
            echo "JVM startup attempt $i: ${startup_time}ms"
            
            kill $APP_PID
            sleep 2
          done
          
      - name: Test Native startup time
        run: |
          echo "Testing Native startup time..."
          for i in {1..3}; do
            start_time=$(date +%s%N)
            ./target/crud-app &
            APP_PID=$!
            
            # Wait for app to be ready
            timeout 10 bash -c 'until curl -f http://localhost:8080/api/users/health 2>/dev/null; do sleep 0.1; done'
            end_time=$(date +%s%N)
            startup_time=$(( (end_time - start_time) / 1000000 ))
            echo "Native startup attempt $i: ${startup_time}ms"
            
            kill $APP_PID
            sleep 2
          done