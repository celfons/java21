# CI/CD Pipeline para Deploy Automatizado no Azure
# Workflow para build e deploy dos containers Docker no Azure Container Registry e Azure Web Apps

name: 'Deploy para Azure'

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  # ConfiguraÃ§Ãµes do Azure Container Registry
  ACR_REGISTRY: ${{ secrets.ACR_REGISTRY }}
  ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
  ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
  
  # ConfiguraÃ§Ãµes do Azure Web App
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  
  # ConfiguraÃ§Ã£o do MongoDB Atlas para produÃ§Ã£o
  MONGODB_ATLAS_CONNECTION_STRING: ${{ secrets.MONGODB_ATLAS_CONNECTION_STRING }}
  
  # Imagens Docker
  KAFKA_CONNECT_IMAGE: kafka-connect-mongodb
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: 'Build e Push para ACR'
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    outputs:
      image-tag: ${{ env.IMAGE_TAG }}
      kafka-connect-image: ${{ env.ACR_REGISTRY }}/${{ env.KAFKA_CONNECT_IMAGE }}:${{ env.IMAGE_TAG }}
    
    steps:
      - name: 'Checkout do cÃ³digo'
        uses: actions/checkout@v4

      - name: 'Configurar Docker Buildx'
        uses: docker/setup-buildx-action@v3

      - name: 'Login no Azure Container Registry'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_REGISTRY }}
          username: ${{ env.ACR_USERNAME }}
          password: ${{ env.ACR_PASSWORD }}

      - name: 'Build e Push da imagem Kafka Connect'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/${{ env.KAFKA_CONNECT_IMAGE }}:${{ env.IMAGE_TAG }}
            ${{ env.ACR_REGISTRY }}/${{ env.KAFKA_CONNECT_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: 'Verificar imagens criadas'
        run: |
          echo "âœ… Imagem Kafka Connect: ${{ env.ACR_REGISTRY }}/${{ env.KAFKA_CONNECT_IMAGE }}:${{ env.IMAGE_TAG }}"

  deploy-to-azure:
    name: 'Deploy para Azure Web App'
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: 'Checkout do cÃ³digo'
        uses: actions/checkout@v4

      - name: 'Login no Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 'Deploy do Kafka Connect para Azure Web App'
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          images: ${{ needs.build-and-push.outputs.kafka-connect-image }}

      - name: 'Configurar variÃ¡veis de ambiente da aplicaÃ§Ã£o'
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0
          inlineScript: |
            # Configurar connection string do MongoDB Atlas
            az webapp config appsettings set \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --settings \
                MONGO_CONNECTION_STRING="${{ env.MONGODB_ATLAS_CONNECTION_STRING }}" \
                CONNECT_BOOTSTRAP_SERVERS="${{ secrets.KAFKA_BOOTSTRAP_SERVERS }}" \
                CONNECT_GROUP_ID="connect-cluster-prod" \
                CONNECT_CONFIG_STORAGE_TOPIC="connect-configs-prod" \
                CONNECT_OFFSET_STORAGE_TOPIC="connect-offsets-prod" \
                CONNECT_STATUS_STORAGE_TOPIC="connect-status-prod" \
                ENVIRONMENT="production" \
                IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"

      - name: 'Restart do Azure Web App'
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0
          inlineScript: |
            az webapp restart \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }}

      - name: 'Verificar status do deploy'
        uses: azure/CLI@v1
        with:
          azcliversion: 2.53.0
          inlineScript: |
            # Aguardar alguns segundos para o restart
            sleep 30
            
            # Verificar status da aplicaÃ§Ã£o
            status=$(az webapp show \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --query "state" -o tsv)
            
            echo "Status da aplicaÃ§Ã£o: $status"
            
            if [ "$status" = "Running" ]; then
              echo "âœ… Deploy realizado com sucesso!"
              echo "ğŸŒ URL da aplicaÃ§Ã£o: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
            else
              echo "âŒ Erro no deploy. Status: $status"
              exit 1
            fi

      - name: 'NotificaÃ§Ã£o de sucesso'
        if: success()
        run: |
          echo "ğŸš€ Deploy para Azure concluÃ­do com sucesso!"
          echo "ğŸ“¦ Imagem: ${{ needs.build-and-push.outputs.kafka-connect-image }}"
          echo "ğŸ·ï¸  Tag: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "ğŸŒ URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"

  health-check:
    name: 'VerificaÃ§Ã£o de SaÃºde'
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-to-azure]
    if: always() && needs.deploy-to-azure.result == 'success'
    
    steps:
      - name: 'Aguardar inicializaÃ§Ã£o da aplicaÃ§Ã£o'
        run: sleep 60

      - name: 'Verificar saÃºde da aplicaÃ§Ã£o'
        run: |
          echo "ğŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
          
          # Tentar conectar na API do Kafka Connect
          for i in {1..10}; do
            if curl -f -s "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net:8083/connectors" > /dev/null; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo corretamente!"
              echo "ğŸ”— API Kafka Connect: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net:8083"
              exit 0
            else
              echo "â³ Tentativa $i/10 - Aguardando aplicaÃ§Ã£o..."
              sleep 30
            fi
          done
          
          echo "âŒ AplicaÃ§Ã£o nÃ£o estÃ¡ respondendo apÃ³s 5 minutos"
          exit 1

      - name: 'RelatÃ³rio final'
        if: always()
        run: |
          echo "ğŸ“Š RELATÃ“RIO DO DEPLOY"
          echo "======================="
          echo "ğŸ·ï¸  Tag da imagem: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "ğŸ“¦ Imagem Kafka Connect: ${{ needs.build-and-push.outputs.kafka-connect-image }}"
          echo "ğŸŒ URL da aplicaÃ§Ã£o: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "ğŸ”— API Kafka Connect: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net:8083"
          echo "â° Deploy realizado em: $(date)"